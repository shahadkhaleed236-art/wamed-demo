import OpenAI from "openai";

const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});


// =========================
// RULE ENGINE (ูุจู ุงูุฐูุงุก ุงูุงุตุทูุงุนู)
// =========================

function ruleEngine(text){

const t = text;

// โซ ุจุทูุงู ูุทูู
if(/ุงูุชุญุงู|ุดุฎุตูุฉ|ุญุณุงุจ ุดุฎุต ุขุฎุฑ|ุนุฏู ุชุจููุบ|ูุง ููุฌุฏ ุชุจููุบ|ูููุฉ ุบูุฑ ูุทุงุจูุฉ/.test(t)){
return {
level:"BLACK",
reason:"ุจุทูุงู ูุญุชูู ููุณ ุงููููุฉ ุฃู ุงูุชุจููุบ",
hint:"ุชุญูู ูู ุตุญุฉ ุงููููุฉ ูุงูุชุจููุบ"
};
}

// ๐ด ูุฎุงููุฉ ุฌุณููุฉ / ุณููุท ุญู
if(/ุจุนุฏ ุงููููุฉ|ุงูุชูุงุก ุงููููุฉ|ุฅููุงู ุจุงุจ ุงููุฑุงูุนุฉ|ุชูุฏูู ูุชุฃุฎุฑ|ุชุตููุฑ ุงูุฌูุณุฉ/.test(t)){
return {
level:"RED",
reason:"ูุฎุงููุฉ ุฌุณููุฉ ุฃู ุณููุท ุญู ุฅุฌุฑุงุฆู",
hint:"ุฑุงุฌุน ุงููููุฉ ูุงูุฅุฐู ุงููุธุงูู"
};
}

// ๐ต ููุต ูู ุงูุฃุซุฑ
if(/ุบูุฑ ูุงุถุญ|ุตูุฑุฉ ุถูุฆูุฉ|ูุง ูููู ุงููุฑุงุกุฉ|ุฎูู ุตูุชู|ุงููุทุงุน ุงูุตูุช/.test(t)){
return {
level:"BLUE",
reason:"ููุต ูุคุซุฑ ุนูู ูุถูุญ ุงูุฃุซุฑ",
hint:"ุฃุนุฏ ุฑูุน ุงููุฑูู ุฃู ุชุญูู ูู ุงูุตูุช"
};
}

// ๐ฃ ูุณุคูููุฉ ุชุฃุฏูุจูุฉ
if(/ุฃููุงุธ ุบูุฑ ูุงุฆูุฉ|ุนุจุงุฑุงุช ุบูุฑ ูุงุฆูุฉ|ุฅูุดุงุก ูุนูููุงุช|ุงุทูุงุน ุบูุฑ ูุตุฑุญ/.test(t)){
return {
level:"PURPLE",
reason:"ุณููู ูุฏ ููุฌุจ ูุณุคูููุฉ ุชุฃุฏูุจูุฉ",
hint:"ุชู ุฑุตุฏ ุงูุณููู"
};
}

// ๐ ูุฎุงููุฉ ุดูููุฉ
if(/ุชุฃุฎุฑ ุฅุฑุณุงู|ุฎุทุฃ ุจุงูุงุณู|ุงุฎุชูุงู ุชูุฌุฆุฉ|ุจูุงูุงุช ุบูุฑ ุฏูููุฉ/.test(t)){
return {
level:"ORANGE",
reason:"ูุฎุงููุฉ ุดูููุฉ ูุง ุชุจุทู ุงูุฅุฌุฑุงุก",
hint:"ุตุญุญ ุงูุจูุงูุงุช ุงูุดูููุฉ"
};
}

return null;
}



// =========================
// API HANDLER
// =========================

export async function POST(req){

try{

const { text } = await req.json();


// ---- ุชุญูู ุฃุณุงุณู ----
if(!text || text.length < 10){
return Response.json({
level:"GRAY",
reason:"ุงููุต ุบูุฑ ูุงูู ููุชุญููู",
hint:"ุฃุฏุฎู ูุตููุง ุฃุทูู"
});
}


// ---- RULES FIRST ----
const ruled = ruleEngine(text);

if(ruled){
return Response.json({
...ruled,
source: "rules"
});
}


// ---- AI FALLBACK ----

const prompt = `
ุฃูุช ูุณุงุนุฏ ุฅุฌุฑุงุฆู ูุงูููู.
ุญูู ุงููุต ูุฃุนุฏ JSON ููุท ุจูุฐุง ุงูุดูู:

{
"level": "BLACK | RED | BLUE | PURPLE | ORANGE | GREEN | GRAY",
"reason": "ุณุจุจ ูุฎุชุตุฑ",
"hint": "ุชูุตูุฉ ูุตูุฑุฉ"
}

ุงููุต:
${text}
`;

const r = await client.responses.create({
model: "gpt-5-mini",
input: prompt
});


const raw = r.output[0].content[0].text;

try{
const parsed = JSON.parse(raw);

return Response.json({
...parsed,
source: "ai"
});

}catch{
return Response.json({
level:"GRAY",
reason:"ุชุนุฐุฑ ุชูุณูุฑ ูุชูุฌุฉ ุงูุฐูุงุก ุงูุงุตุทูุงุนู",
hint:"ูุชุทูุจ ูุฑุงุฌุนุฉ ุจุดุฑูุฉ",
source:"ai-parse-fail"
});
}

}catch(e){

return Response.json({
level:"GRAY",
reason:"ุฎุทุฃ ูู ุงูุฎุงุฏู",
hint:"ุชุญูู ูู ุฅุนุฏุงุฏุงุช ุงูููุชุงุญ",
error:String(e)
});

}

}
